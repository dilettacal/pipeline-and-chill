graph TB
    %% Data Sources
    subgraph "Data Sources"
        NYC[("🗽 NYC Taxi Data<br/>Parquet Files")]
        REF[("📋 Reference Data<br/>Zones, Lookups")]
    end

    %% Ingestion Layer
    subgraph "Ingestion Layer"
        BATCH["📥 Batch Processor<br/>Monthly Data Loading"]
        CURATE["🔧 Data Curation<br/>Quality Checks"]
    end

    %% Streaming Layer
    subgraph "Streaming Layer"
        PRODUCER["📡 Event Producer<br/>Trip → Events"]
        KAFKA[("⚡ Kafka<br/>Event Streaming")]
        ASSEMBLER["🔧 Trip Assembler<br/>Events → Trips"]
        REDIS[("⚡ Redis<br/>State Management")]
    end

    %% Storage Layer
    subgraph "Storage Layer"
        POSTGRES[("🗄️ PostgreSQL<br/>Complete Trips")]
    end

    %% Analytics Layer
    subgraph "Analytics Layer"
        AGGREGATOR["📊 KPI Aggregator<br/>Zone Hourly Stats"]
        REPORTS["📈 Reports<br/>Analytics & Insights"]
    end

    %% Infrastructure
    subgraph "Infrastructure"
        DOCKER["🐳 Docker<br/>Containerization"]
        CI["🔄 GitHub Actions<br/>CI/CD Pipeline"]
        TERRAFORM["🏗️ Terraform<br/>Infrastructure as Code"]
    end

    %% Data Flow
    NYC --> BATCH
    REF --> BATCH
    BATCH --> CURATE
    CURATE --> POSTGRES

    %% Streaming Path
    NYC --> PRODUCER
    PRODUCER --> KAFKA
    KAFKA --> ASSEMBLER
    ASSEMBLER <--> REDIS
    ASSEMBLER --> POSTGRES

    %% Analytics Path
    POSTGRES --> AGGREGATOR
    AGGREGATOR --> REPORTS

    %% Infrastructure connections
    DOCKER -.-> BATCH
    DOCKER -.-> PRODUCER
    DOCKER -.-> ASSEMBLER
    CI -.-> DOCKER
    TERRAFORM -.-> DOCKER

    %% Styling
    classDef dataSource fill:#e1f5fe,stroke:#01579b,stroke-width:2px,color:#000
    classDef processing fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,color:#000
    classDef storage fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px,color:#000
    classDef analytics fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#000
    classDef infrastructure fill:#fce4ec,stroke:#880e4f,stroke-width:2px,color:#000

    class NYC,REF dataSource
    class BATCH,CURATE,PRODUCER,ASSEMBLER,REDIS processing
    class POSTGRES,KAFKA storage
    class AGGREGATOR,REPORTS analytics
    class DOCKER,CI,TERRAFORM infrastructure
